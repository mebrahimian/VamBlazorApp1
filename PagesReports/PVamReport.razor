@page "/pvamreport"
@inject DatabaseContext _Db
@inject SandoghService SandoghService
@inject VamBlazor.Client.Application.Services.PersonServices PersonServices
@layout MainLayoutReports
@inject NavigationManager Navigation
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@using MudBlazor
@using VamBlazor.Client.Application.Dtos
@using VamBlazor.Client.Application.Services
@using VamBlazor.Client.Application.CommonFunc
@using VamBlazor.Client.Domain.Entities


<!-- دکمه برای چاپ گزارش -->

<MudButton @onclick="PrintReport" Variant="Variant.Filled"
           Class="ma-0 pa-0"
           StartIcon="@Icons.Material.Filled.Print"
           IconColor="Color.Primary"
           Style="@($"display:{(isButtonVisible ? "flex" : "none")};width:100px")">
    چاپ گزارش
</MudButton>
<div style="text-align:center">
    @SandoghName
    <br />
    گزارش پرداخت وام از تاریخ @cDate1 تا تاریخ @cDate2  
    <br/>
    @(cType == "1" ? "" : "وامهای ضروری")
    
</div>
<!-- این خط برای جلوگیری از تداخل و شروع جدید در هر رکورد -->
<div style="clear: both;"></div>
<div style="display: flex; width: 98%; margin-left:0;">
    <MudTable T="PersonPVamDto" Items="@ReportRecords" Hover="true" RowsPerPage="20" Bordered="true" Striped="true" Dense="true" Style="width:95%; align-items:center; font-size:10px; table-layout: fixed; padding-right: 10px;">

        <HeaderContent>
            <MudTh Style="width:75px;text-align:center">ردیف</MudTh> <!-- ستون شماره ردیف -->
            
            <MudTh Style="width:75px">ش.حساب</MudTh>
            <MudTh Style="width:75px">تاریخ وام</MudTh>
            <MudTh Style="width:100px">مبلغ وام</MudTh>
            <MudTh Style="width:250px"> مشخصات سپرده گذار</MudTh>
            
            
        </HeaderContent>
        <RowTemplate>
            <MudTd>@TextHelper.ConvertToPersian((ReportRecords.IndexOf(context) + 1).ToString(), false)</MudTd> <!-- شماره ردیف --> <!-- اعداد فارسی بدون کاما  -->
            
            <MudTd>@TextHelper.ConvertToPersian(context.HesabNo.ToString(), false)</MudTd>  <!-- اعداد فارسی بدون کاما  -->
            <MudTd>@TextHelper.ConvertNumbersInStringToPersian(context.DateD)</MudTd>
            <MudTd>@TextHelper.ConvertToPersian(context.Mblgvam?.ToString("N0") ?? "")</MudTd>
            <MudTd>@context.FullName</MudTd>
            
            
        </RowTemplate>
        <FooterContent>
            <MudTd colspan="3" Class="text-right">جمع:</MudTd> <!-- جمع برای 4 ستون اول -->
            <MudTd>@TextHelper.ConvertToPersian(ReportRecords.Sum(x => x.Mblgvam)?.ToString("N0"))</MudTd>  <!-- جمع مبلغ وام (ستون ۵) -->
            <MudTd></MudTd>  <!-- برای "مشخصات سپرده گذار" چیزی چاپ نمی‌شود -->
            
            
        </FooterContent>

    </MudTable>
</div>



<br />
<div style="page-break-after: always;"></div>

@code {
    private int PageNumber { get; set; } = 1; // شماره صفحه (پیش‌فرض صفحه اول)
    private int PageSize { get; set; } = 20;  // تعداد رکوردها در هر صفحه (پیش‌فرض 20 رکورد)
    
    private List<PersonPVamDto> ReportRecords { get; set; }
    private List<IGrouping<long, PersonReportStatusDto>> groupedRecords { get; set; }
    private string CurrentPersonPictureAddress = string.Empty;
    private AccountInfoDto PersonInfo = new AccountInfoDto();
    private string SandoghName = "";

    public string cDate1 { get; set; }
    public string cDate2 { get; set; }
    public string cType {get; set;}
    public long nHesab1 { get; set; }
    public long nHesab2 { get; set; }
    private bool isTransactionTableStarted = false;
    protected override async Task OnInitializedAsync()
    {
    // دریافت پارامترهای URL
    var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);

    cDate1 = GetQueryStringValue(uri, "date1");
    cDate2 = GetQueryStringValue(uri, "date2");
    cType = GetQueryStringValue(uri, "type");
    var query = (from Person in _Db.Persons
                     join Qvam in _Db.Qvams on Person.Code equals Qvam.Pcode
                     join Hesab in _Db.Hesabs on Person.Code equals Hesab.Pcode
                     join Pvam in _Db.Pvams on Qvam.ReqNo equals Pvam.ReqNo into PvamGroup
                     from Pvam in PvamGroup.DefaultIfEmpty()  // اینجا LEFT JOIN برای Pvam اعمال شده است
                     select new
                     {
                         FullName = Person.FullName,
                         Pcode = Person.Code,
                         HesabNo = Hesab.HesabNo,
                         ReqNoQ = Qvam.ReqNo,
                         MblgvamQ = Qvam.Mblg,
                         TypeQ = Qvam.Type,
                         ReqNoP = Pvam != null ? Pvam.ReqNo : 0,
                         Mblgvam = Pvam != null ? Pvam.Mblgvam : 0,  // اگر Pvam null باشد مقدار null می‌دهیم
                         Gst1 = Pvam != null ? Pvam.Gst1 : 0,
                         Gst2 = Pvam != null ? Pvam.Gst2 : 0,
                         Pkarmozd = Pvam != null ? Pvam.Pkarmozd : 0,
                         Mkarmozd = Pvam != null ? Pvam.Mkarmozd : 0,
                         GstNo = Pvam != null ? Pvam.GstNo : 0,
                         GstPay = Pvam != null ? Pvam.GstPay : 0,
                         DateD = Pvam != null ? Pvam.DateD : "",
                         DateG = Pvam != null ? Pvam.DateG : "",
                         Type = Pvam != null ? Pvam.Type : '1',
                         Status = Qvam.Status,
                         isEditable = (Pvam != null ? Pvam.GstPay : 0) == 0
                         // isEditable = !_Db.Dargsts.Any(p => p.ReqNo == (Pvam != null ? Pvam.ReqNo : 0))  // اگر Pvam null باشد، مقدار 0 به جای ReqNo استفاده می‌شود
                     }).Where(t => t.Type == cType[0] && string.Compare(t.DateD, cDate1) >= 0 && string.Compare(t.DateD, cDate2) <= 0).ToList();  // تبدیل به لیست

        if (query != null && query.Any())
        {
            ReportRecords = query.Select(q => new PersonPVamDto
            {
                FullName = q.FullName,
                Pcode = q.Pcode,
                HesabNo = q.HesabNo,
                ReqNo = q.ReqNoP,
                Status = q.Status,
                Mblgvam = q.Mblgvam,
                Gst1 = q.Gst1,
                Gst2 = q.Gst2,
                Pkarmozd = q.Pkarmozd,
                Mkarmozd = q.Mkarmozd,
                GstNo = q.GstNo,
                GstPay = q.GstPay,
                DateD = q.DateD,
                DateG = q.DateG,
                isEditable = q.isEditable
            }).OrderBy(q => q.DateD).ThenBy(q => q.HesabNo).ToList();
        }

    SandoghName = SandoghService.GetSandoghName();

    }


    // متد کمکی برای دریافت مقدار پارامتر از URL
    private string GetQueryStringValue(Uri uri, string key)
    {
    var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
    return query.ContainsKey(key) ? query[key].ToString() : string.Empty;
    }
    private bool isButtonVisible = true;

    private MudTheme myTheme = new MudTheme()
    {
    Typography = new Typography()
    {
    Default = new Default()
    {
    FontFamily = ["Vazir UI", "sans-serif"]

    }
    }
    };
    // رکورد ست شامل اطلاعات هر شخص

    // دستور چاپ با استفاده از JSInterop
    private async Task PrintReport()
    {
    isButtonVisible = !isButtonVisible;
    StateHasChanged();
    await Task.Delay(1000);
    await JSRuntime.InvokeVoidAsync("window.printAndRedirect", "/pagepersonstatus", 500);
    }
    }
